# 应用层编码指南
**原则**：两件事情

1. `CQS`：命令的定义与实现；查询的定义；
2. `事件`：领域事件的订阅；集成事件的发布与订阅；

## 中介者
cap4j提供中介者模式来方便调用各个模型设计元素。
> `聚合工厂中介者`: `Mediator`.`factories`().`create`(_entityPayload_); // 创建聚合根实例
>
> `仓储中介者`: `Mediator`.`repositories`().`find*`(); // 查询检索聚合根
>
> `领域服务中介者`: `Mediator`.`service`().`getService`(_domainServiceClass_); // 查询检索聚合根
>
> `工作单元实例`: `Mediator`.`uow`().`persist`(_entity_)、`remove`(_entity_)、 `save`(); // 聚合根实例字段变更同步持久化
>
> `集成事件中介者`: `Mediator`.`events`().`attach`(_eventPayload_); // 发布集成事件
>
> `命令中介者`: `Mediator`.`commands`().`send`(_commandRequest_); // 发出命令请求
>
> `查询中介者`: `Mediator`.`queries`().`send`(_queryRequest_); // 发出命令请求
>
> `请求中介者`: `Mediator`.`requests`().`send`(_request_); // 发出请求

## 代码生成
cap4j提供快速创建模型设计元素。


## 命令
**代码位置规范**：`${basePackage}.application.commands`

重点关注使用`聚合工厂中介者`、`仓储中介者`、`工作单元实例`。

在某些情形下会使用到`请求中介者`执行外部服务请求，以及`集成事件中介者`对外发出集成事件。

特别需慎用`领域服务中介者`，警惕领域模型贫血化问题。

### 
`Mediator`.`repositories`()



## 查询
基于CQS模式，查询可独立实现。不必依赖领域模型（领域层）实现，可直接依据DI原则，由适配层实现即可。

应用层仅需提供查询(Query)出入参(Request\Response)声明定义。

### 查询响应类
```java
package org.netcorepal.cap4j.ddd.example.application.queries.order;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * todo: 查询响应描述
 *
 * @author cap4j-ddd-codegen
 * @date 2024/09/09
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class GetOrderQryResponse {
    Long id;
}

```

### 查询参数类
```java
package org.netcorepal.cap4j.ddd.example.application.queries.order;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.netcorepal.cap4j.ddd.application.RequestParam;


/**
 * todo: 查询请求参数描述
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class GetOrderQryRequest implements RequestParam<GetOrderQryResponse> {
    Long id;
}
```

## 集成事件声明
**代码位置规范**：`${basePackage}.application.distributed.events`

仅需标记@IntegrationEvent 注解，即可定义集成事件。
```java
@IntegrationEvent(value = "some-integration-event-topic", subscriber = "${spring.application.name}")
public class SomeIntegrationEvent {
    // 省略消息体字段定义...
}
```

## 集成事件发布
### 显式发布集成事件
**代码位置规范**：`${basePackage}.application.subscribers.domain`包中的领域事件订阅实现逻辑中；

**代码位置规范**：`${basePackage}.application.commands`包中的命令实现逻辑中。

```java
Mediator.events().attach(SomeIntegrationEvent.builder()
        //...
        .build());
```


>[Mediator](../ddd-core/src/main/java/org/netcorepal/cap4j/ddd/Mediator.java).`events`()
返回[IntegrationEventSupervisor](ddd-core/src/main/java/org/netcorepal/cap4j/ddd/application/event/IntegrationEventSupervisor.java)接口。
### 声明式发布集成事件
集成事件声明上标记`@AutoRelease`注解。cap4j将会利用反射技术关联到对应领域事件的发布并自动触发集成事件的发布。
```java
package org.netcorepal.cap4j.ddd.example.application.distributed.events;

import org.netcorepal.cap4j.ddd.example.domain.aggregates.order.events.OrderClosedDomainEvent;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.netcorepal.cap4j.ddd.application.event.annotation.AutoRelease;
import org.netcorepal.cap4j.ddd.application.event.annotation.IntegrationEvent;

/**
 * todo: 集成事件描述
 *
 * @author cap4j-ddd-codegen
 * @date 2024/09/09
 */
@IntegrationEvent(value = "cap4j-example-order-placed", subscriber = "${spring.application.name}")
@AutoRelease(sourceDomainEventClass = OrderClosedDomainEvent.class)
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class OrderClosedIntegrationEvent implements Converter<OrderClosedDomainEvent, OrderClosedIntegrationEvent> {
    private Long id;

    @Override
    public OrderClosedIntegrationEvent convert(OrderClosedDomainEvent source) {
        return OrderClosedIntegrationEvent.builder()
                .id(source.getId())
                //...
                .build();
    }
}

```

## 集成事件订阅
**代码位置规范**：`${basePackage}.application.subscribers.integration`

实现对应事件的[EventSubscriber](../ddd-core/src/main/java/org/netcorepal/cap4j/ddd/domain/event/EventSubscriber.java)
服务并标记`@Service`注解注册到`Spring IoC`容器中，即可实现对应事件发生时订阅逻辑的自动触发调用。


## 领域事件订阅，
**代码位置规范**：`${basePackage}.application.subscribers.domain`
领域事件与集成事件的订阅在业务上的职责与概念并无差别，接口也并无差别。

直接参考集成事件订阅说明。

## SAGA
待实现...
